## ä¸€ã€JESTç®€ä»‹

Jestæ˜¯Facebookå¼€æºçš„ä¸€å¥—JavaScriptæµ‹è¯•æ¡†æ¶ï¼Œ å®ƒé›†æˆäº†æ–­è¨€ã€JSDomã€è¦†ç›–ç‡æŠ¥å‘Šç­‰å¼€å‘è€…æ‰€éœ€è¦çš„æ‰€æœ‰æµ‹è¯•å·¥å…·ã€‚

> å®˜æ–¹ç®€ä»‹ï¼šä¸€ä¸ªä»¤äººæ„‰å¿«çš„javascriptæµ‹è¯•æ¡†æ¶ã€‚
> æˆ‘çš„ç†è§£æ˜¯ï¼Œä¸ç”¨åŠ ç­æ”¹bugäº†ï¼Œå¯ä»¥æå‰ä¸‹ç­ï¼Œé™ªå¥³æœ‹å‹å–å¥¶èŒ¶ï¼

## äºŒã€jestå¯æ­¥
## 2.1 å®‰è£…
```bash
# é¡¹ç›®ä¸­ä½¿ç”¨
yarn init -y
yarn add --dev jest
# æˆ–è€…å…¨å±€å®‰è£…ï¼Œéšæ—¶éšåœ°ä½¿ç”¨
yarn global add jest  
```

## 2.2 hello world(jest)
ç¼–å†™ä»¥ä¸‹ä¸¤ä¸ªjsæ–‡ä»¶ï¼Œæ§åˆ¶å°è¾“å…¥å‘½ä»¤`jest --no-cache --verbose`(å…¨å±€å®‰è£…)ï¼Œæˆ–è€…`npx jest --no-cache --verbose`ï¼ˆé¡¹ç›®ä¾èµ–å®‰è£…ï¼‰ï¼Œjestä¼šæœç´¢é¡¹ç›®ä¸‹æ‰€æœ‰æµ‹è¯•è„šæœ¬å¹¶æ‰§è¡Œè¾“å‡ºæµ‹è¯•ç»“æœã€‚
```javascript
// hello.js
module.exports = function(){
    return "hello world";
}
// hello.test.js
const hello = require('../hello');

it('should ', () => {
    expect(hello()).toBe('hello world');
});

```

## ä¸‰ã€åŸºç¡€æµ‹è¯•çŸ¥è¯†

## 3.1 jestæ–‡ä»¶å’Œç›®å½•å‘½åè§„èŒƒ
å¾…æµ‹è¯•æ–‡ä»¶: `hello.js`
æµ‹è¯•è„šæœ¬æ–‡ä»¶å–åï¼š`hello.test.js`or`hello.spec.js`
æµ‹è¯•ç›®å½•:`tests`or`__tests__`


## 3.2 æµ‹è¯•å‡½æ•°
```javascript
test("æµ‹è¯•ç”¨åˆ—æè¿°ä¿¡æ¯",()=>{

})
// or
it("æµ‹è¯•ç”¨ä¾‹æè¿°ä¿¡æ¯",()=>{

})
```

## 3.3 æ–­è¨€å‡½æ•°
> æµ‹è¯•å³è¿è¡Œç»“æœæ˜¯å¦ä¸æˆ‘ä»¬é¢„æœŸç»“æœä¸€è‡´
> æ–­è¨€å‡½æ•°ç”¨æ¥éªŒè¯ç»“æœæ˜¯å¦æ­£ç¡®
```javascript
exspect(è¿è¡Œç»“æœ).toBe(æœŸæœ›çš„ç»“æœ);
//å¸¸è§æ–­è¨€æ–¹æ³•
expect({a:1}).toBe({a:1})//åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰
expect(1).not.toBe(2)//åˆ¤æ–­ä¸ç­‰
expect({ a: 1, foo: { b: 2 } }).toEqual({ a: 1, foo: { b: 2 } })
expect(n).toBeNull(); //åˆ¤æ–­æ˜¯å¦ä¸ºnull
expect(n).toBeUndefined(); //åˆ¤æ–­æ˜¯å¦ä¸ºundefined
expect(n).toBeDefined(); //åˆ¤æ–­ç»“æœä¸toBeUndefinedç›¸å
expect(n).toBeTruthy(); //åˆ¤æ–­ç»“æœä¸ºtrue
expect(n).toBeFalsy(); //åˆ¤æ–­ç»“æœä¸ºfalse
expect(value).toBeGreaterThan(3); //å¤§äº3
expect(value).toBeGreaterThanOrEqual(3.5); //å¤§äºç­‰äº3.5
expect(value).toBeLessThan(5); //å°äº5
expect(value).toBeLessThanOrEqual(4.5); //å°äºç­‰äº4.5
expect(value).toBeCloseTo(0.3); // æµ®ç‚¹æ•°åˆ¤æ–­ç›¸ç­‰
expect('Christoph').toMatch(/stop/); //æ­£åˆ™è¡¨è¾¾å¼åˆ¤æ–­
expect(['one','two']).toContain('one'); //ä¸è§£é‡Š
```

## 3.4 åˆ†ç»„å‡½æ•°
```javascript
describe("å…³äºæ¯ä¸ªåŠŸèƒ½æˆ–æŸä¸ªç»„ä»¶çš„å•å…ƒæµ‹è¯•",()=>{
    // ä¸åŒç”¨ä¾‹çš„å•å…ƒæµ‹è¯•
})
```

## 3.5 å¸¸è§å‘½ä»¤
```json
{
  "nocache": "jest --no-cache", //æ¸…é™¤ç¼“å­˜
  "watch": "jest --watchAll", //å®æ—¶ç›‘å¬
  "coverage": "jest --coverage",  //ç”Ÿæˆè¦†ç›–æµ‹è¯•æ–‡æ¡£
  "verbose": "npx jest --verbose" //æ˜¾ç¤ºæµ‹è¯•æè¿°
}
```

## å››ã€åŸºç¡€æµ‹è¯•

## 4.1 å¯¹è±¡ç­‰å€¼æµ‹è¯•
```javascript
describe('å¯¹è±¡æµ‹è¯•', () => {

    it("æ˜¯å¦åŒä¸€ä¸ªå¯¹è±¡", () => {
        const foo = { a: 1 }
        expect(foo).toBe(foo)
    })

    it("å¯¹è±¡å€¼æ˜¯å¦ç›¸ç­‰", () => {
        expect({ a: 1, foo: { b: 2 } }).toEqual({ a: 1, foo: { b: 2 } })
    })

    test('å¯¹è±¡èµ‹å€¼', () => {
        const data = { one: 1 };
        data['two'] = 2;
        expect(data).toEqual({ one: 1, two: 2 });
    });

});
```

## 4.2 å¼‚æ­¥æµ‹è¯•
å¼‚æ­¥æµ‹è¯•è„šæœ¬æ‰§è¡Œå®Œï¼Œå•å…ƒæµ‹è¯•å°±ç»“æŸäº†ï¼Œå¦‚æœéœ€è¦å»¶æ—¶æ‰èƒ½æ–­è¨€çš„ç»“æœï¼Œå•å…ƒæµ‹è¯•å‡½æ•°éœ€è¦è®¾ç½®`done`å½¢å‚ï¼Œåœ¨å®šæ—¶å›è°ƒå‡½æ•°ä¸­è°ƒç”¨ï¼Œæ˜¾ç¤ºçš„é€šè¿‡å•å…ƒæµ‹è¯•å·²å®Œæˆã€‚
```javascript
describe('å¼‚æ­¥æ“ä½œæµ‹è¯•',  () => {
    function foo(callback) {
        console.log('foo...')
        setTimeout(() => {
            callback && callback();
        }, 1000)
    }
    it('å¼‚æ­¥æµ‹è¯•', (done) => {
        function bar() {
            console.log('bar..')
            done();
        }
        foo(bar);
    });
});

```
## 4.3 å®šæ—¶å™¨æµ‹è¯•ï¼ˆå¼‚æ­¥æµ‹è¯•ï¼‰åŠæ–­è¨€
åŸºäºjestæä¾›çš„ä¸¤ä¸ªæ–¹æ³•`jest.useFakeTimers`å’Œ`jest.runAllTimers`å¯ä»¥æ›´ä¼˜é›…çš„å¯¹å»¶æ—¶åŠŸèƒ½çš„æµ‹è¯•ã€‚
```javascript
describe('å®šæ—¶å™¨ç›¸å…³æµ‹è¯•', () => {
    // å¼€å¯å®šæ—¶å‡½æ•°æ¨¡æ‹Ÿ
    jest.useFakeTimers();
    
    function foo(callback) {
        console.log('foo...')
        setTimeout(() => {
            callback && callback();
        }, 1000)
    }
    it('æ–­è¨€å¼‚æ­¥æµ‹è¯•', () => {
        //åˆ›å»ºmockå‡½æ•°ï¼Œç”¨äºæ–­è¨€å‡½æ•°è¢«æ‰§è¡Œæˆ–æ˜¯æ‰§è¡Œæ¬¡æ•°çš„åˆ¤æ–­
        const callback = jest.fn();
        foo(callback);
        expect(callback).not.toBeCalled();
        //å¿«è¿›ï¼Œä½¿æ‰€æœ‰å®šæ—¶å™¨å›è°ƒ
        jest.runAllTimers();
        expect(callback).toBeCalled();
    })
});
```
## 4.4 Domæµ‹è¯•
å®ç°domæ¸²æŸ“æµ‹è¯•ï¼Œä»¥åŠç‚¹å‡»äº‹ä»¶ç­‰äº¤äº’åŠŸèƒ½æµ‹è¯•ã€‚
```javascript
describe('Domæµ‹è¯•', () => {
    it('æµ‹è¯•æŒ‰é’®æ˜¯å¦è¢«æ¸²æŸ“ ', () => {
        document.body.innerHTML = `
    <div>
        <button id='btn'>å°æŒ‰é’®</button>
    </div> `
        console.log(document.getElementById('btn'), document.getElementById('btn').toString())
        expect(document.getElementById('btn')).not.toBeNull();
        expect(document.getElementById('btn').toString()).toBe("[object HTMLButtonElement]");
    });

    it('æµ‹è¯•ç‚¹å‡»äº‹ä»¶', () => {
        const onclick = jest.fn();
        document.body.innerHTML = `
        <div>
            <button id='btn'>å°æŒ‰é’®</button>
        </div> `
        const btn = document.getElementById('btn');
        expect(onclick).not.toBeCalled();
        btn.onclick = onclick;
        btn.click();
        expect(onclick).toBeCalled();
        expect(onclick).toHaveBeenCalledTimes(1);
        btn.click();
        btn.click();
        expect(onclick).toHaveBeenCalledTimes(3);
    });
});
```


## äº”ã€Vueæµ‹è¯•
## 5.1 å®‰è£…unit-jest
å¦‚æœä½ åˆ›å»ºçš„é¡¹ç›®æ²¡æœ‰å®‰è£…unit-jestä¾èµ–åŒ…ï¼Œå¯ä»¥é€šè¿‡`vue add @vue/unit-jest`å‘½ä»¤æ·»åŠ ã€‚å¦åˆ™é€šè¿‡è„šæ‰‹æ¶æ‰‹åŠ¨æ¨¡å¼åˆ›å»ºä¸€ä¸ªåŒ…å«unit-jestçš„é¡¹ç›®ã€‚

## 5.2 åŸºç¡€çŸ¥è¯†
**mountå’ŒshallowMountçš„åŒºåˆ«**
- shallowMountåªæŒ‚è½½æŒ‡å®šç»„ä»¶ï¼Œä¸æŒ‚è½½å­ç»„ä»¶
- mountæŒ‚è½½æ‰€æœ‰ç»„ä»¶

**Vueçš„æ¸²æŸ“æœºåˆ¶**
é»˜è®¤æƒ…å†µä¸‹ Vue ä¼šå¼‚æ­¥åœ°æ‰¹é‡æ‰§è¡Œæ›´æ–° (åœ¨ä¸‹ä¸€è½® tick)ï¼Œä»¥é¿å…ä¸å¿…è¦çš„ DOM é‡ç»˜æˆ–è€…æ˜¯è§‚å¯Ÿè€…è®¡ç®—
> å¼‚æ­¥æµ‹è¯•éœ€è¦åœ¨nextTick()ä¹‹åæ‰§è¡Œ

## 5.3 hello Jest Vue
vueç»„ä»¶æ¸²æŸ“æµ‹è¯•
```javascript
it('æŒ‚è½½countBtnç»„ä»¶', () => {
        const wraper = shallowMount(CountBtn);
        const btn = wraper.find("button");
        expect(wraper.html()).toBe(`<button>ç‚¹å‡»æ¬¡æ•°0</button>`);
    });
```

## 5.4 äº‹ä»¶æµ‹è¯•
vueç»„ä»¶ç‚¹å‡»äº‹ä»¶æµ‹è¯•
```javascript
it('æµ‹è¯•countBtnç»„ä»¶ç‚¹å‡»', (done) => {
    const wraper = shallowMount(CountBtn);
    const btn = wraper.find("button");
    expect(wraper.html()).toBe(`<button>ç‚¹å‡»æ¬¡æ•°0</button>`);
    btn.trigger('click');
    setTimeout(() => {
        expect(wraper.html()).toBe(`<button>ç‚¹å‡»æ¬¡æ•°1</button>`);
        done();
    }, 1000);
});

it('ä¼˜é›…çš„æµ‹è¯•ç‚¹å‡»äº‹ä»¶', async () => {
    const wraper = shallowMount(CountBtn);
    const btn = wraper.find("button");
    expect(wraper.html()).toBe(`<button>ç‚¹å‡»æ¬¡æ•°0</button>`);
    btn.trigger('click');
    await wraper.vm.$nextTick();
    expect(wraper.html()).toBe(`<button>ç‚¹å‡»æ¬¡æ•°1</button>`);
});
```

## 5.5 axioså¼‚æ­¥è¯·ç¤ºæµ‹è¯•
æ¨¡æ‹Ÿå¼‚æ­¥è¯·ç¤ºï¼Œæµ‹è¯•æ¸²æŸ“ç»“æœæ˜¯å¦ä¸€è‡´
```html
<!-- User.vue -->
<template>
<table>
    <tr v-for="item in list" :key="item.id">
        <td>{{item.id}}</td>
        <td>{{item.name}}</td>
        <td>{{item.age}}</td>
    </tr>
</table>
</template>

<script>
export default {
    data() {
        return {
            list: []
        }
    },
    created() {
        this.$http.get('/user').then(({
            data
        }) => {
            this.list = data
        })
    }
}
</script>
```

```javascript
// User.spec.js
import { mount } from '@vue/test-utils';
import User from '@/components/User';

it('æµ‹è¯•ç”¨æˆ·ç»„ä»¶', async() => {
    const wrapper = mount(User,{
        mocks:{
            $http:{
                get: url=>Promise.resolve({data:[{id:1,name:'xxxx',age:18},{id:2,name:'yyyy',age:19}]})
            }
        }
    })
    console.log(wrapper.html())
    // æ¸²æŸ“å‰
    expect(wrapper.html()).toBe('<table></table>');
    await wrapper.vm.$nextTick();
    // æ¸²æŸ“å
    // console.log(wrapper.html())
    // console.log(wrapper.find('tr'))
    expect(wrapper.findAll('tr').length).toBe(2)
    expect(wrapper.findAll('td').at(2).html()).toBe('<td>18</td>')
    
});
```

## å…­ã€demoæºç 
[githubåœ°å€](http://github.com/calcyu/jest-study-demo)
demoä¸­è¿˜åŒ…å«`express+restful`æ¥å£çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä¸æƒ³ç”¨`postman`æµ‹è¯•æ¥å£çš„åŒå­¦ï¼Œå¯ä»¥ç”¨jestæ¥ä»£æ›¿ã€‚

> é¡ºæ‰‹ç‚¹ä¸ªå°çˆ±å¿ƒï¼Œä»¥ç¤ºé¼“åŠ±ã€‚ğŸ˜˜ğŸ˜ğŸ¥°



